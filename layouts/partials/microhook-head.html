<script src="https://cdnjs.cloudflare.com/ajax/libs/lite-youtube-embed/0.2.0/lite-yt-embed.js" defer></script>

{{ $post_class := $.Site.Params.post_class }}

<script defer>
  document.addEventListener('DOMContentLoaded', () => {
    const postClass = '{{ or $post_class "post-content" }}';
    const processedVideos = new Set();

    // Select both post-content (detail pages) and e-content (homepage) elements
    const postContents = document.querySelectorAll(`.${postClass}, .e-content`);
    postContents.forEach(p => {
        const links = [...p.getElementsByTagName('a')]

        links.forEach(l => {
            if (!l.href) return

            // Check if link is a YouTube URL
            if (!(l.href.includes('youtube.com') || l.href.includes('youtu.be'))) return

            // https://gist.github.com/jphase/9086823
            const matches = l.href.match(/(http:|https:)?(\/\/)?(www\.)?(youtube.com|youtu.be)\/(watch|embed)?(\?v=|\/)?(\S+)?/)

            if (!matches || !matches[7]) return

            const ytId = matches[7]

            // Find the paragraph containing the link
            const paragraph = l.closest('p')
            if (!paragraph) return

            // Create unique key to prevent duplicate embeds
            const videoKey = `${ytId}-${paragraph.textContent.substring(0, 50)}`;

            if (processedVideos.has(videoKey)) return
            processedVideos.add(videoKey)

            const video = document.createElement('lite-youtube')
            video.setAttribute('videoid', ytId)
            video.setAttribute('playlabel', l.innerText || 'Play Video')

            // Try to load HD thumbnail first, fallback to SD if not available
            const hdThumb = `https://i.ytimg.com/vi/${ytId}/maxresdefault.jpg`
            const sdThumb = `https://i.ytimg.com/vi/${ytId}/sddefault.jpg`

            const img = new Image()
            img.onload = function() {
              // HD thumbnail exists
              video.style.backgroundImage = `url('${hdThumb}')`
            }
            img.onerror = function() {
              // HD thumbnail not available, use SD
              video.style.backgroundImage = `url('${sdThumb}')`
            }
            img.src = hdThumb

            // Insert video right after the paragraph
            paragraph.insertAdjacentElement('afterend', video)
        })
      })
  });
</script>
