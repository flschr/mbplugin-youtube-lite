<script
    src="https://cdnjs.cloudflare.com/ajax/libs/lite-youtube-embed/0.3.3/lite-yt-embed.js"
    integrity="sha384-5K8DvA/jQItSqMzBuJJX/9Up/DVImOuA7VTJuJux3zXhblA+NzZPI/rHSgIeEadg"
    crossorigin="anonymous"
    defer
    onload="console.log('lite-youtube script loaded successfully')"
    onerror="console.error('Failed to load lite-youtube script from CDN')">
</script>

{{ $post_class := $.Site.Params.post_class }}

<script>
    // Wait for both DOM and lite-youtube script to be ready
    function processYouTubeLinks() {
        console.log('processYouTubeLinks called');
        const postClass = '{{ or $post_class "post-content" }}';
        const processedVideos = new Set();

        // Select both post-content (detail pages) and e-content (homepage) elements
        const postContents = document.querySelectorAll(`.${postClass}, .e-content`);
        console.log(`Found ${postContents.length} post containers`);

        let videosCreated = 0;

        postContents.forEach(container => {
            const links = [...container.getElementsByTagName('a')];
            console.log(`Found ${links.length} links in container`);

            links.forEach(link => {
                if (!link.href) return;

                // Check if link is a YouTube URL
                if (!(link.href.includes('youtube.com') || link.href.includes('youtu.be'))) return;

                console.log(`Found YouTube link: ${link.href}`);

                // Extract YouTube video ID
                // https://gist.github.com/jphase/9086823
                const matches = link.href.match(/(http:|https:)?(\/\/)?(www\.)?(youtube.com|youtu.be)\/(watch|embed)?(\?v=|\/)?(\S+)?/);

                if (!matches || !matches[7]) {
                    console.warn(`Could not extract video ID from ${link.href}`);
                    return;
                }

                const ytId = matches[7];
                console.log(`Extracted video ID: ${ytId}`);

                // Find the paragraph containing the link
                const paragraph = link.closest('p');
                if (!paragraph) {
                    console.warn(`No paragraph found for link ${link.href}`);
                    return;
                }

                // Create unique key to prevent duplicate embeds
                const videoKey = `${ytId}-${paragraph.textContent.substring(0, 50)}`;

                if (processedVideos.has(videoKey)) {
                    console.log(`Video ${ytId} already processed, skipping`);
                    return;
                }
                processedVideos.add(videoKey);

                // Create lite-youtube element
                const video = document.createElement('lite-youtube');
                video.setAttribute('videoid', ytId);
                video.setAttribute('playlabel', link.innerText || 'Play Video');

                console.log(`Creating lite-youtube element for video ${ytId}`);

                // Insert video right after the paragraph
                paragraph.insertAdjacentElement('afterend', video);
                videosCreated++;
            });
        });

        console.log(`Created ${videosCreated} lite-youtube elements`);
    }

    function initLiteYouTube() {
        console.log('initLiteYouTube called');

        // Check if customElements is available (lite-youtube needs it)
        if (typeof customElements === 'undefined') {
            console.warn('Custom elements not supported - lite-youtube will not work');
            return;
        }

        console.log('Custom elements supported, waiting for lite-youtube definition...');

        // Set a timeout fallback in case the element never gets defined
        let processed = false;

        // Wait for the lite-youtube custom element to be defined before creating elements
        customElements.whenDefined('lite-youtube').then(() => {
            console.log('lite-youtube element defined, processing links');
            if (!processed) {
                processed = true;
                processYouTubeLinks();
            }
        }).catch(err => {
            console.error('Error loading lite-youtube:', err);
        });

        // Fallback: if after 3 seconds the element still isn't defined, try anyway
        setTimeout(() => {
            if (!processed) {
                console.warn('lite-youtube not defined after 3s, attempting to process anyway');
                processed = true;
                processYouTubeLinks();
            }
        }, 3000);
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        console.log('DOM loading, adding event listener');
        document.addEventListener('DOMContentLoaded', initLiteYouTube);
    } else {
        // DOM already loaded (e.g., when script is deferred)
        console.log('DOM already loaded, initializing immediately');
        initLiteYouTube();
    }
</script>
