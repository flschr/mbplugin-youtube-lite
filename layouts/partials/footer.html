<script src="https://cdnjs.cloudflare.com/ajax/libs/lite-youtube-embed/0.2.0/lite-yt-embed.js"></script>

{{ $post_class := $.Site.Params.post_class }}

 <script>
    (function() {
      const postClass = '{{ or $post_class "post-content" }}';
      const processedVideos = new Set(); // Prevent duplicates

      function initYouTubeEmbeds() {
        // Select both post-content (detail pages) and e-content (homepage) elements
        const postContents = document.querySelectorAll(`.${postClass}, .e-content`);
        postContents.forEach(p => {
            const links = [...p.getElementsByTagName('a')]

            links.forEach(l => {
                if (!l.href) return

                // Check if link is a YouTube URL
                if (!(l.href.includes('youtube.com') || l.href.includes('youtu.be'))) return

                // https://gist.github.com/jphase/9086823
                const matches = l.href.match(/(http:|https:)?(\/\/)?(www\.)?(youtube.com|youtu.be)\/(watch|embed)?(\?v=|\/)?(\S+)?/)

                if (!matches || !matches[7]) return

                const ytId = matches[7]

                // Find the paragraph containing the link
                const paragraph = l.closest('p')
                if (!paragraph) return

                // Create unique key to prevent duplicate embeds
                const videoKey = `${ytId}-${paragraph.textContent.substring(0, 50)}`;

                if (processedVideos.has(videoKey)) return
                processedVideos.add(videoKey)

                const video = document.createElement('lite-youtube')
                video.setAttribute('videoid', ytId)
                video.setAttribute('playlabel', l.innerText || 'Play Video')

                // Try to load HD thumbnail first, fallback to SD if not available
                const hdThumb = `https://i.ytimg.com/vi/${ytId}/maxresdefault.jpg`
                const sdThumb = `https://i.ytimg.com/vi/${ytId}/sddefault.jpg`

                const img = new Image()
                img.onload = function() {
                  // HD thumbnail exists
                  video.style.backgroundImage = `url('${hdThumb}')`
                }
                img.onerror = function() {
                  // HD thumbnail not available, use SD
                  video.style.backgroundImage = `url('${sdThumb}')`
                }
                img.src = hdThumb

                // Insert video right after the paragraph
                paragraph.insertAdjacentElement('afterend', video)
            })
          })
      }

      // Run immediately if DOM is already loaded, otherwise wait for DOMContentLoaded
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initYouTubeEmbeds);
      } else {
        initYouTubeEmbeds();
      }
    })();
</script>

<style>
    /* Minimal styles for lite-youtube to function - visual styles come from theme */
    lite-youtube {
        position: relative;
        display: block;
        contain: content;
        background-position: center center;
        background-size: cover;
        cursor: pointer;
    }

    /* 16:9 aspect ratio */
    lite-youtube::after {
        content: "";
        display: block;
        padding-bottom: calc(100% / (16 / 9));
    }

    lite-youtube > iframe {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        border: 0;
    }

    /* Play button */
    lite-youtube > .lty-playbtn {
        display: block;
        width: 68px;
        height: 48px;
        position: absolute;
        cursor: pointer;
        transform: translate3d(-50%, -50%, 0);
        top: 50%;
        left: 50%;
        z-index: 1;
        background-color: transparent;
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 68 48"><path d="M66.52 7.74c-.78-2.93-2.49-5.41-5.42-6.19C55.79.13 34 0 34 0S12.21.13 6.9 1.55c-2.93.78-4.63 3.26-5.42 6.19C.06 13.05 0 24 0 24s.06 10.95 1.48 16.26c.78 2.93 2.49 5.41 5.42 6.19C12.21 47.87 34 48 34 48s21.79-.13 27.1-1.55c2.93-.78 4.64-3.26 5.42-6.19C67.94 34.95 68 24 68 24s-.06-10.95-1.48-16.26z" fill="red"/><path d="M45 24 27 14v20" fill="white"/></svg>');
        filter: grayscale(100%);
        transition: filter .1s cubic-bezier(0, 0, 0.2, 1);
        border: none;
    }

    lite-youtube:hover > .lty-playbtn,
    lite-youtube .lty-playbtn:focus {
        filter: none;
    }

    /* Post-click styles */
    lite-youtube.lyt-activated {
        cursor: unset;
    }

    lite-youtube.lyt-activated::before,
    lite-youtube.lyt-activated > .lty-playbtn {
        opacity: 0;
        pointer-events: none;
    }

    .lyt-visually-hidden {
        clip: rect(0 0 0 0);
        clip-path: inset(50%);
        height: 1px;
        overflow: hidden;
        position: absolute;
        white-space: nowrap;
        width: 1px;
    }
</style>