<script src="/plugin/mbplugin-youtube-lite/js/lite-yt-embed.js"></script>

{{ $post_class := $.Site.Params.post_class }}

<script>
(function() {
    'use strict';

    // Compile regex patterns once for better performance
    const YOUTUBE_REGEX = /(?:youtube\.com\/(?:watch\?v=|embed\/|shorts\/|live\/)|youtu\.be\/)([a-zA-Z0-9_-]{11})(?:[?&]([^#\s]*))?/;
    const TIMESTAMP_REGEX = /[?&]t=(?:(\d+)h)?(?:(\d+)m)?(?:(\d+)s?)?/;
    const PLAYLIST_REGEX = /[?&]list=([a-zA-Z0-9_-]+)/;

    /**
     * Extract video ID and parameters from YouTube URL
     * Supports: regular videos, shorts, live streams, playlists, timestamps
     */
    function parseYouTubeUrl(url) {
        try {
            const match = url.match(YOUTUBE_REGEX);
            if (!match || !match[1]) return null;

            const videoId = match[1];
            const params = {};

            // Extract timestamp (e.g., ?t=1m30s or &t=90)
            const timeMatch = url.match(TIMESTAMP_REGEX);
            if (timeMatch) {
                const hours = parseInt(timeMatch[1]) || 0;
                const minutes = parseInt(timeMatch[2]) || 0;
                const seconds = parseInt(timeMatch[3]) || 0;
                const totalSeconds = hours * 3600 + minutes * 60 + seconds;
                if (totalSeconds > 0) {
                    params.start = totalSeconds;
                }
            }

            // Preserve playlist parameter
            const playlistMatch = url.match(PLAYLIST_REGEX);
            if (playlistMatch) {
                params.list = playlistMatch[1];
            }

            return { videoId, params };
        } catch (error) {
            console.error('Error parsing YouTube URL:', url, error);
            return null;
        }
    }

    /**
     * Create and insert lite-youtube element
     */
    function createVideoEmbed(videoData, linkElement, paragraph) {
        try {
            const video = document.createElement('lite-youtube');
            video.setAttribute('videoid', videoData.videoId);
            video.setAttribute('playlabel', linkElement.innerText?.trim() || 'Play Video');

            // Add parameters if any exist
            if (Object.keys(videoData.params).length > 0) {
                const paramString = new URLSearchParams(videoData.params).toString();
                video.setAttribute('params', paramString);
            }

            // Insert video after paragraph
            paragraph.insertAdjacentElement('afterend', video);

            // Debug: Check if background image was set after a short delay
            setTimeout(() => {
                const bgImage = window.getComputedStyle(video).backgroundImage;
                if (!bgImage || bgImage === 'none') {
                    console.warn('[YouTube Plugin] Background image not set for video:', videoData.videoId, 'Element:', video);
                }
            }, 100);

            return true;
        } catch (error) {
            console.error('Error creating video embed:', error);
            return false;
        }
    }

    /**
     * Process YouTube links in content containers
     */
    function processYouTubeLinks() {
        // Check if lite-youtube custom element is defined
        if (typeof customElements === 'undefined' || !customElements.get('lite-youtube')) {
            console.error('[YouTube Plugin] lite-youtube custom element is not defined. The lite-yt-embed.js script may have failed to load.');
            return;
        }

        const postClass = '{{ or $post_class "post-content" }}';
        const processedVideos = new Set();

        // Select content containers
        const containers = document.querySelectorAll(`.${postClass}, .e-content`);

        containers.forEach(container => {
            // Use getElementsByTagName for better performance (live HTMLCollection)
            const links = container.getElementsByTagName('a');

            // Convert to array only once for iteration
            Array.from(links).forEach(link => {
                // Validate link
                if (!link.href || typeof link.href !== 'string') return;

                // Quick check before regex
                const href = link.href;
                if (!href.includes('youtube.com') && !href.includes('youtu.be')) return;

                // Parse URL
                const videoData = parseYouTubeUrl(href);
                if (!videoData) return;

                // Find containing paragraph
                const paragraph = link.closest('p');
                if (!paragraph) return;

                // Generate unique key to prevent duplicates
                // Use a combination of videoId, container, and link position
                const containerIndex = Array.from(containers).indexOf(container);
                const linkIndex = Array.from(links).indexOf(link);
                const videoKey = `${videoData.videoId}-${containerIndex}-${linkIndex}`;

                // Skip if already processed
                if (processedVideos.has(videoKey)) return;
                processedVideos.add(videoKey);

                // Create embed
                createVideoEmbed(videoData, link, paragraph);
            });
        });
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', processYouTubeLinks);
    } else {
        // DOM already loaded
        processYouTubeLinks();
    }
})();
</script>

<style>
    lite-youtube {
        background-color: #000;
        position: relative;
        display: block;
        contain: content;
        background-position: center center;
        background-size: cover;
        cursor: pointer;
        max-width: 720px;
        width: 100%;
        min-width: 200px;
        margin-bottom: 10px;
    }

    /* gradient */
    lite-youtube::before {
        content: '';
        display: block;
        position: absolute;
        top: 0;
        background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAADGCAYAAAAT+OqFAAAAdklEQVQoz42QQQ7AIAgEF/T/D+kbq/RWAlnQyyazA4aoAB4FsBSA/bFjuF1EOL7VbrIrBuusmrt4ZZORfb6ehbWdnRHEIiITaEUKa5EJqUakRSaEYBJSCY2dEstQY7AuxahwXFrvZmWl2rh4JZ07z9dLtesfNj5q0FU3A5ObbwAAAABJRU5ErkJggg==);
        background-position: top;
        background-repeat: repeat-x;
        height: 60px;
        padding-bottom: 50px;
        width: 100%;
        transition: all 0.2s cubic-bezier(0, 0, 0.2, 1);
    }

    /* responsive iframe with a 16:9 aspect ratio
        thanks https://css-tricks.com/responsive-iframes/
    */
    lite-youtube::after {
        content: "";
        display: block;
        padding-bottom: calc(100% / (16 / 9));
    }
    lite-youtube > iframe {
        width: 100%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
        border: 0;
    }

    /* play button */
    lite-youtube > .lty-playbtn {
        display: block;
        width: 68px;
        height: 48px;
        position: absolute;
        cursor: pointer;
        transform: translate3d(-50%, -50%, 0);
        top: 50%;
        left: 50%;
        z-index: 1;
        background-color: transparent;
        /* YT's actual play button svg */
        background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 68 48"><path d="M66.52 7.74c-.78-2.93-2.49-5.41-5.42-6.19C55.79.13 34 0 34 0S12.21.13 6.9 1.55c-2.93.78-4.63 3.26-5.42 6.19C.06 13.05 0 24 0 24s.06 10.95 1.48 16.26c.78 2.93 2.49 5.41 5.42 6.19C12.21 47.87 34 48 34 48s21.79-.13 27.1-1.55c2.93-.78 4.64-3.26 5.42-6.19C67.94 34.95 68 24 68 24s-.06-10.95-1.48-16.26z" fill="red"/><path d="M45 24 27 14v20" fill="white"/></svg>');
        filter: grayscale(100%);
        transition: filter .1s cubic-bezier(0, 0, 0.2, 1);
        border: none;
    }

    lite-youtube:hover > .lty-playbtn,
    lite-youtube .lty-playbtn:focus {
        filter: none;
    }

    /* Post-click styles */
    lite-youtube.lyt-activated {
        cursor: unset;
    }
    lite-youtube.lyt-activated::before,
    lite-youtube.lyt-activated > .lty-playbtn {
        opacity: 0;
        pointer-events: none;
    }

    .lyt-visually-hidden {
        clip: rect(0 0 0 0);
        clip-path: inset(50%);
        height: 1px;
        overflow: hidden;
        position: absolute;
        white-space: nowrap;
        width: 1px;
    }
</style>